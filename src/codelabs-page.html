<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/codelab-components/google-codelab-elements.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="codelabs-page">
  <template>
    <style>
      :root {
        --google-codelab-header-background: var(--secondary-color);
        --paper-blue-500: var(--secondary-color);
        --google-codelab-fab-background: var(--secondary-color);
      }
      :host {
        display: block;
        min-height: 100vh;
      }
      google-codelab-step {
        --google-codelab-step-code: {
          font-family: 'Ubuntu Mono',Helvetica,Arial;
        };
        --google-codelab-step-warn: {
          border: 1px solid #ED3146;
          background: rgba(237, 49, 70, 0.1);
          color: #333;
        };
        --google-codelab-step-tip: {
          border: 1px solid #ECA918;
          background: rgba(236, 169, 24, 0.1);
          color: #333;
        };
      }
      #contentContainer google-codelab pre {
        background-color: var(--color-light);
        border-radius: 2px;
        border: 1px solid var(--color-mid-light);
        color: var(--color-dark);
      }
      #contentContainer google-codelab pre .str,
      #contentContainer google-codelab pre .kwd,
      #contentContainer google-codelab pre .com,
      #contentContainer google-codelab pre .typ,
      #contentContainer google-codelab pre .lit,
      #contentContainer google-codelab pre .pun,
      #contentContainer google-codelab pre .pln,
      #contentContainer google-codelab pre .tag,
      #contentContainer google-codelab pre .atn,
      #contentContainer google-codelab pre .atv,
      #contentContainer google-codelab pre .dec {
        color: #333;
      }
      #contentContainer google-codelab-step::shadow .instructions {
        /* TODO: Move arrows down on smaller viewports */
        /*margin-bottom: 96px;*/
      }
      #contentContainer google-codelab-survey {
        border: 1px solid #19B6EE;
        background: rgba(25, 182, 238, 0.1);
        border-radius: 2px;
      }
      #contentContainer google-codelab p img {
        /* Override images being forced at 100% width */
        width: auto;
      }
      .subscribeForm {
        text-align:center;
        padding: 1em;
      }
      /* Sign up form */
      #plusone {
        width: 56px;
        height: 56px;
        font-size: 3.2em;
        border-radius: 50px;
        background-color: white;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }
      #form-content {
        text-align: left;

      }
      #form-meta {
        text-align: center;
        padding: 20px;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        max-width: 350px;
        margin: auto;
        padding-top: 20px;
        margin-top: 20px;
        display: block;
        font-size: 1rem;
        line-height: 1.5;
      }
      paper-button[type=submit]{
        box-sizing: border-box;
        font-size: 1.14286em;
        margin-bottom: 0.75em;
        -webkit-border-radius: 3px;
        -moz-border-radius: 3px;
        border-radius: 3px;
        background: #dd4814;
        color: #fff;
        text-decoration: none;
        display: inline-block;
        margin: 0;
        font-family: Ubuntu, Arial, 'libra sans', sans-serif;
        font-weight: 300;
        -webkit-font-smoothing: subpixel-antialiased;
        -moz-font-smoothing: subpixel-antialiased;
        -o-font-smoothing: subpixel-antialiased;
        font-smoothing: subpixel-antialiased;
        padding: 8px 14px;
        width: 100%;
        text-align: center;
      }
      input[type=input] {
        border-radius: 2px;
        background: #fff;
        border: 1px solid #999;
        display: block;
        font-family: Ubuntu,Arial,"libra sans",sans-serif;
        font-size: 1em;
        font-weight: 300;
        padding: 0.6956522em 0.869565em;
        width:320px;
      }

    </style>

    <app-route
      route="{{route}}"
      pattern="/:codelab"
      data="{{routeData}}"
      tail="{{routeTail}}">
    </app-route>
    <iron-ajax
      id="tutorialAjax"
      url="[[url]]/index.html"
      handle-as="text"
      loading="{{loading}}"
      on-response="_loadTutorial">
    </iron-ajax>
    <div id="contentContainer"></div>
  </template>

  <script>
    Polymer({
      is: 'codelabs-page',

      properties: {
        url: {
          type: String,
          computed: '_codelaburl(routeData.codelab)'
        },
        route: {
          type: String,
        },
        loading: {
          type: Boolean,
          notify: true,
          value: false,
        },
        codelabs: {
          type: Array,
          notify: true,
        },
      },

      observers: [
        '_handleLoading(loading, url)',
        '_onPageChange(routeData.codelab)',
      ],

      _onPageChange: function(slug) {
        if (slug) {
          this.$.tutorialAjax.generateRequest();
        }
      },

      _handleLoading: function(loading) {
        if (loading !== true) {
          return;
        }
        Polymer.dom(this.$.contentContainer).innerHTML = '';
      },

      _updateMetadata: function() {
        if (!this.codelabs) {
          return;
        }
        var currentUrl = this.routeData.codelab;
        var metadata = this.codelabs.filter(function(metadata) {
          return metadata.url === currentUrl;
        })[0];
        if (metadata !== undefined) {
          this.fire('app-metadata', {
            title: metadata.title + ' | Ubuntu tutorials',
            description: metadata.summary,
          });
        }
      },

      _codelabsInfoHandler: function(event) {
        this.categoriesmap = event.detail.response["categories"];
        this.eventsmap = event.detail.response["events"];
        event.detail.response["codelabs"].forEach(function(codelab) {
          this.push("codelabs", codelab);
        }, this);

        // Force a binding update. Officially recommended, really!
        // https://www.polymer-project.org/1.0/docs/devguide/model-data#override-dirty-check
        var codelabs = this.codelabs;
        this.codelabs = [];
        this.codelabs = codelabs;
        this._updateMetadata();
      },

      _loadTutorial: function(e, url) {
        this._updateMetadata();
        const resp = e.detail.response;
        Polymer.dom(this.$.contentContainer).innerHTML = resp.replace(/CODELABURL/g, this.url);
        for (i = 0; i < Polymer.dom(this.$.contentContainer).querySelectorAll('h2').length; i++) {
            var h2Node = Polymer.dom(this.$.contentContainer).querySelectorAll('h2')[i];
            if (h2Node.innerHTML == "Next steps") {
                h2Node.outerHTML = '\
                <div class="subscribeForm" >\
                  <h3>How was your learning experience?</h3>\
                  <div onMouseUp="this.childNodes[3].hidden ? this.childNodes[3].hidden=false : null;this.childNodes[1].hidden=true;">\
                    <p><paper-button id="plusone">&#x1f44d;</paper-button>\
                       <paper-button id="plusone">&#x1f44e;</paper-button></p>\
                    <iron-form hidden="true" id="form-signup">\
                      <div id="form-meta">\
                        <span style="font-size:1.3em;">You can keep growing your skills!</span>\
                        <br>\
                        <span style="font-size:1em;">Sign up to be notified of new tutorials.</span>\
                        <br>\
                        <div id="form-content">\
                          <br>\
                          <label>Email address:  </label>\
                          <input type="input" name="email" value=""><br>\
                          <paper-button type="submit" value="Keep me posted">Keep me posted</paper-button>\
                        </div>\
                      </div>\
                    </iron-form>\
                  </div>\
                </div>\
                <h2>Next steps</h2>';
            }
        }

      },

      _codelaburl: function(codelabpath) {
        return '/src/codelabs/' + codelabpath;
      },
    });
  </script>
</dom-module>
